{% extends "user/base.html" %}

{% block content %}
<!-- External libraries -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom@1.5.1/dist/drift-basic.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  /* ---
  * PRODUCT DETAIL THEME: Cosmic Glow Integration
  --- */
  .untree_co-section { padding-top: 50px; padding-bottom: 50px; color: #E2E8F0; }
  
  /* Gallery Styles */
  .product-gallery { display: flex; gap: 15px; }
  .thumbnails-col { flex: 0 0 80px; display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto; }
  .thumbnail-img { width: 100%; border: 2px solid #334155; border-radius: 8px; cursor: pointer; transition: border-color 0.3s; display: block; }
  .thumbnail-img:hover, .thumbnail-img.active { border-color: #00D9C0; }
  .thumbnail-container.video-thumb::after { content: 'â–º'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; background-color: rgba(0, 0, 0, 0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  
  .main-image-container { flex: 1; border: 1px solid #334155; border-radius: 12px; position: relative; overflow: hidden; background-color: #0F172A; aspect-ratio: 1 / 1; }
  .main-product-image, .main-product-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; object-fit: cover; }
  .main-product-video { background-color: #000; }
  
  /* Details Styles */
  .product-details .product-title { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; font-weight: 700; color: #ffffff; }
  .product-details .price { font-size: 2.2rem; color: #00D9C0; font-weight: bold; margin-bottom: 25px; }
  .breadcrumb-item a { color: #94A3B8; text-decoration: none; }
  .breadcrumb-item a:hover { color: #00D9C0; }

  /* Attributes Table Styles */
  .product-attributes-table th { width: 100px; color: #94A3B8; font-weight: 400; text-align: left; padding-right: 15px; vertical-align: top; }
  .product-attributes-table td { padding: 8px 0; font-weight: 600; color: #E2E8F0; }
  .color-swatch { display: inline-block; width: 18px; height: 18px; border-radius: 50%; border: 1px solid #475569; vertical-align: middle; margin-right: 8px; }
  
  /* Meta/Tags Section */
  .product-meta { border-top: 1px solid #334155; margin-top: 30px; padding-top: 20px; font-size: 0.9rem; }
  .product-meta-item strong { color: #94A3B8; min-width: 90px; display: inline-block; }
  .product-meta-item span, .product-meta-item a { color: #E2E8F0; text-decoration: none; transition: color .3s; }
  .product-meta-item a:hover { color: #00D9C0; }

  /* Info Tabs */
  .product-info-tabs { margin-top: 50px; border-top: 1px solid #334155; padding-top: 20px; }
  .nav-tabs .nav-link { background-color: transparent; border-color: #334155; color: #94A3B8; }
  .nav-tabs .nav-link.active { background-color: #1E293B; border-color: #334155; color: #ffffff; }
  .tab-content { color: #94A3B8; padding: 20px 0; }
  .additional-info-table th { color: #94A3B8; }
  .additional-info-table td { color: #E2E8F0; }

  /* --- MODIFIED: Styles for Cart & Notify Buttons --- */
  .btn-action-group {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .btn-action-group .btn {
    flex-grow: 1; /* Makes both buttons take up available space */
    font-size: 1rem;
    padding: 12px 20px;
  }
</style>

<div class="untree_co-section">
  <div class="container">
    {% if product %}
      <div class="row">
        <!-- Left Column: Image & Video Gallery -->
        <div class="col-lg-6 mb-5 mb-lg-0">
          <div class="product-gallery">
            <div class="thumbnails-col">
              {% for image_url in product.images_list %}<div class="thumbnail-container"><img src="/static/{{ image_url }}" alt="Thumbnail {{ loop.index }}" class="thumbnail-img {% if loop.first %}active{% endif %}" data-type="image" data-src="/static/{{ image_url }}" onclick="changeMedia(this)"></div>{% endfor %}
              {% for video_url in product.videos_list %}<div class="thumbnail-container video-thumb"><img src="/static/{{ product.images_list[0] if product.images_list else 'user/images/default-product.png' }}" alt="Video Thumbnail" class="thumbnail-img" data-type="video" data-src="/static/{{ video_url }}" onclick="changeMedia(this)"></div>{% endfor %}
            </div>
            <div class="main-image-container">
              <img src="/static/{{ product.images_list[0] if product.images_list else 'user/images/default-product.png' }}" class="main-product-image" id="main-product-image" data-zoom="/static/{{ product.images_list[0] if product.images_list else 'user/images/default-product.png' }}" alt="{{ product.name }}">
              <video src="" class="main-product-video" id="main-product-video" poster="/static/{{ product.images_list[0] if product.images_list else 'user/images/default-product.png' }}" controls loop muted playsinline style="display: none;"></video>
            </div>
          </div>
        </div>

        <!-- Right Column: Product Details -->
        <div class="col-lg-6 product-details">
          <nav aria-label="breadcrumb"><ol class="breadcrumb bg-transparent p-0 mb-2">
            <li class="breadcrumb-item"><a href="{{ url_for('user.user_home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="#">{{ product.category_name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li></ol>
          </nav>
          <h1 class="product-title">{{ product.name }}</h1>
          <p class="price" id="display-price">$0.00</p>
          
          <table class="product-attributes-table"><tbody>
              <tr><th>Weight:</th><td><span id="display-weight">N/A</span> <span id="display-weight-unit" class="text-muted ms-1"></span></td></tr>
              <tr><th>Size:</th><td><span id="display-size">N/A</span></td></tr>
              {% if product.shape_name %}<tr><th>Shape:</th><td>{{ product.shape_name }}</td></tr>{% endif %}
              {% if product.color_name %}<tr><th>Color:</th><td>{% if product.color_hex_code %}<span class="color-swatch" style="background-color: {{ product.color_hex_code }};"></span>{% endif %}{{ product.color_name }}</td></tr>{% endif %}
          </tbody></table>
          
          {% if sizes %}
          <div class="mb-3">
            <label for="product_size_id" class="form-label"><strong>Select Option:</strong></label>
            <select name="product_size_id" id="product_size_id" class="form-select" required onchange="updateProductDetails()">
              {% for size in sizes %}{% set available_stock = (size.stock_count or 0) - (size.purchase_count or 0) %}{% set is_out_of_stock = size.stock_count is none or available_stock <= 0 %}<option value="{{ size.id }}" data-price="{{ size.offer_prize or size.size_price or '0.00' }}" data-weight="{{ size.weight or 'N/A' }}" data-size="{{ size.size or 'N/A' }}" data-weight-unit="{{ size.weight_unit_name or '' }}" {% if is_out_of_stock %}disabled{% endif %}>{{ size.size or 'Default' }} {% if is_out_of_stock %}(Out of Stock){% else %}({{ available_stock }} left){% endif %}</option>{% endfor %}
            </select>
          </div>
          {% endif %}
          
          <div class="my-4">
              <div class="d-flex align-items-center gap-3">
                  <!-- Quantity Selector -->
                  <div class="d-flex align-items-center">
                      <label for="quantity" class="form-label mb-0 me-2" style="white-space: nowrap;"><strong>Quantity:</strong></label>
                      <input type="number" id="quantity" class="form-control" style="width: 80px;" min="1" value="1" required>
                  </div>
                  
                  <!-- Button Group Container -->
                  <div class="btn-action-group flex-grow-1">
                      <form method="POST" action="{{ url_for('user.cart') }}" id="add-to-cart-form" class="w-100">
                          <input type="hidden" name="product_id" value="{{ product.id }}">
                          <input type="hidden" name="product_size_id" id="cart_product_size_id">
                          <input type="hidden" name="quantity" id="cart_quantity">
                          <button type="submit" id="add-to-cart-btn" class="btn btn-primary w-100">Add to Cart</button>
                      </form>
                      
                      <form method="POST" action="{{ url_for('user.notify_admin_stock') }}" id="notify-me-form" class="w-100" style="display: none;">
                          <input type="hidden" name="product_size_id" id="notify_product_size_id">
                          <button type="submit" class="btn btn-secondary w-100">
                              <i class="fas fa-bell"></i> Notify Me
                          </button>
                      </form>
                  </div>
              </div>
              <p id="stock-message" class="text-danger mt-2" style="display: none;">This option is out of stock.</p>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning">Product not found.</div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/drift-zoom@1.5.1/dist/Drift.min.js"></script>

<script>
  // RESTORED: All necessary JavaScript functions
  const mainImageEl = document.getElementById('main-product-image');
  const mainVideoEl = document.getElementById('main-product-video');
  let drift;

  function initializeDrift() {
    if (drift) { drift.destroy(); }
    if (mainImageEl) {
      drift = new Drift(mainImageEl, { inlinePane: true, hoverBoundingBox: true, zoomFactor: 2 });
    }
  }

  function changeMedia(thumbnailElement) {
    const dataType = thumbnailElement.dataset.type;
    const mediaSrc = thumbnailElement.dataset.src;
    mainVideoEl.pause();
    document.querySelectorAll('.thumbnail-img').forEach(img => img.classList.remove('active'));
    thumbnailElement.classList.add('active');

    if (dataType === 'image') {
      mainImageEl.style.display = 'block';
      mainVideoEl.style.display = 'none';
      mainImageEl.src = mediaSrc;
      mainImageEl.dataset.zoom = mediaSrc; // Update the zoom source
      initializeDrift();
    } else if (dataType === 'video') {
      mainImageEl.style.display = 'none';
      mainVideoEl.style.display = 'block';
      if (drift) { drift.destroy(); drift = null; }
      mainVideoEl.src = mediaSrc;
      mainVideoEl.load();
      const playPromise = mainVideoEl.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => { console.log("Autoplay prevented.", error); });
      }
    }
  }

  function updateProductDetails() {
    const select = document.getElementById('product_size_id');
    if (!select || select.selectedIndex < 0) return;
    const selectedOption = select.options[select.selectedIndex];
    
    document.getElementById('display-price').textContent = `$${parseFloat(selectedOption.getAttribute('data-price') || 0).toFixed(2)}`;
    document.getElementById('display-weight').textContent = selectedOption.getAttribute('data-weight');
    document.getElementById('display-weight-unit').textContent = selectedOption.getAttribute('data-weight-unit');
    const sizeValue = selectedOption.getAttribute('data-size');
    document.getElementById('display-size').textContent = (sizeValue && sizeValue !== 'N/A') ? `${sizeValue} mm` : 'N/A';
    
    // Update the hidden inputs for both forms
    document.getElementById('cart_product_size_id').value = selectedOption.value;
    document.getElementById('notify_product_size_id').value = selectedOption.value;

    const addToCartForm = document.getElementById('add-to-cart-form');
    const notifyMeForm = document.getElementById('notify-me-form');
    const stockMessage = document.getElementById('stock-message');
    
    if (selectedOption.disabled) {
      addToCartForm.style.display = 'none';
      notifyMeForm.style.display = 'block';
      stockMessage.style.display = 'block';
    } else {
      addToCartForm.style.display = 'block';
      notifyMeForm.style.display = 'none';
      stockMessage.style.display = 'none';
    }
  }

  // Pass the quantity from the visible input to the hidden input before submitting
  document.getElementById('add-to-cart-form').addEventListener('submit', function() {
      document.getElementById('cart_quantity').value = document.getElementById('quantity').value;
  });

  document.addEventListener('DOMContentLoaded', function() {
    initializeDrift();
    const sizeSelector = document.getElementById('product_size_id');
    if (sizeSelector && sizeSelector.options.length > 0) {
        const firstAvailableOption = Array.from(sizeSelector.options).find(opt => !opt.disabled);
        if (firstAvailableOption) {
            sizeSelector.value = firstAvailableOption.value;
        } else {
            sizeSelector.selectedIndex = 0;
        }
        updateProductDetails();
    } else {
        const productPrice = {{ (product.sizes[0].offer_prize or product.sizes[0].size_price) if product and product.sizes else 'null' | tojson }};
        if (productPrice !== null) {
          document.getElementById('display-price').textContent = `$${parseFloat(productPrice).toFixed(2)}`;
        }
    }
  });
</script>
{% endblock %}