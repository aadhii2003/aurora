{% extends "user/base.html" %}

{% block content %}
<style>
  /* ---
  * FONT & THEME STYLING
  --- */
  .shop-hero .intro-excerpt h1,
  .product-item .product-title,
  .no-products-found h4 {
    font-family: 'Cormorant Garamond', serif;
  }
  
  /* --- MODIFIED: Hero Section Styling with Background Image --- */
  .shop-hero {
    /* Increased padding for better visual impact */
    padding: 8rem 0; 
    position: relative;
    background-color: #0F172A; /* Fallback color if image doesn't load */
    
    /* 
      IMPORTANT: Replace the URL below with your own image.
      The first part creates a dark overlay for text readability.
    */
    background-image: linear-gradient(rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.8)), url("https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop&w=2071");
    
    /* Best practices for full-page background images */
    background-size: cover;
    background-position: center center;
    background-attachment: fixed; /* Creates a cool parallax effect on scroll */
  }
  /* --- END OF MODIFICATION --- */

  .shop-hero .intro-excerpt h1 { font-size: clamp(2.5rem, 5vw, 3.5rem); font-weight: 700; color: #ffffff; }
  .shop-hero .intro-excerpt .intro-subtitle { color: #94A3B8; max-width: 600px; margin: 0 auto 30px auto; font-size: 1.1rem; line-height: 1.7; }
  
  .filters-and-products-section { padding: 3rem 0; background-color: #1E293B; }
  
  .top-filter-bar {
    background: #0F172A; padding: 20px 25px; border-radius: 12px;
    border: 1px solid #334155; margin-bottom: 2.5rem;
  }
  
  .filter-sidebar {
    background: #0F172A; padding: 25px; border-radius: 12px;
    border: 1px solid #334155; position: sticky; top: 20px;
  }
  .filter-sidebar h4 {
    font-size: 13px; font-weight: 700; text-transform: uppercase;
    letter-spacing: .08em; display: flex; align-items: center;
    gap: 10px; color: #9D4EDD;
    border-bottom: 1px solid #334155; padding-bottom: 15px; margin-bottom: 25px;
  }
  .master-display-section { margin-top: 2rem; }
  .master-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .color-circle { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #475569; }
  .item-name { font-size: 14px; color: #E2E8F0; font-weight: 500; }
  
  .product-toolbar { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid #334155; color: #94A3B8; }
  .toolbar-item { display: flex; align-items: center; gap: 10px; }
  .per-page-link { color: #94A3B8; text-decoration: none; font-weight: 500; transition: color 0.2s ease; padding: 0 5px; }
  .per-page-link:hover { color: #ffffff; }
  .per-page-link.active { color: #00D9C0; font-weight: 700; }
  .view-mode-btn { color: #94A3B8; font-size: 1.5rem; cursor: pointer; transition: color 0.2s ease; }
  .view-mode-btn:hover { color: #ffffff; }
  .view-mode-btn.active { color: #00D9C0; }

  .product-grid > .product-col { display: flex; flex-direction: column; }
  .product-item { display: flex; flex-direction: column; height: 100%; text-decoration: none; background: #0F172A; border: 1px solid #334155; border-radius: 12px; overflow: hidden; transition: all .3s ease; }
  .product-item:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 217, 192, 0.1); border-color: #00D9C0; }
  .product-thumbnail-wrapper { position: relative; width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background-color: #1E293B; flex-shrink: 0; }
  .product-item .product-thumbnail { width: 100%; height: 100%; object-fit: cover; transition: transform .5s ease; }
  .product-item:hover .product-thumbnail { transform: scale(1.08); }
  .product-content { padding: 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; }
  .product-item .product-title { font-size: 1rem; font-weight: 700; line-height: 1.4; color: #F1F5F9; }
  .product-item .product-price { font-size: 1rem; font-weight: 700; color: #00D9C0; margin-top: auto; padding-top: 8px; display: flex; justify-content: center; align-items: center; gap: 8px; }
  .product-price .old-price { font-size: 0.85rem; color: #94A3B8; text-decoration: line-through; font-weight: 400; }

  .product-item.list-view { flex-direction: row; text-align: left; }
  .product-item.list-view .product-thumbnail-wrapper { width: 150px; height: 150px; aspect-ratio: auto; }
  .product-item.list-view .product-content { text-align: left; }

  .pagination .page-item .page-link { background-color: #334155; border-color: #475569; color: #E2E8F0; }
  .pagination .page-item .page-link:hover { background-color: #475569; }
  .pagination .page-item.active .page-link { background-color: #00D9C0; border-color: #00D9C0; color: #0F172A; }
  .pagination .page-item.disabled .page-link { background-color: #1E293B; border-color: #334155; color: #475569; }
</style>

<div class="shop-hero">
  <div class="container">
    <div class="row justify-content-center text-center">
      <div class="col-lg-8">
        <div class="intro-excerpt">
          <h1>Discover Your Perfect Piece</h1>
          <p class="intro-subtitle">Explore our curated selection of high-quality gemstones, each with a unique story and energy.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="filters-and-products-section">
  <div class="container">
    <form method="GET" action="{{ url_for('user.products') }}" id="filterForm">
        
      <!-- Top Filter Bar -->
      <div class="top-filter-bar">
        <div class="row align-items-center gy-3 gy-lg-0">
            <div class="col-lg-auto"><h4><i class="fas fa-filter"></i><span>Filters</span></h4></div>
            <div class="col-lg col-md-3 col-6"><select name="category_id" class="form-select" onchange="this.form.submit()"><option value="">All Categories</option>{% for c in categories %}<option value="{{ c.id }}" {% if selected_category == c.id|string %}selected{% endif %}>{{ c.category_name }}</option>{% endfor %}</select></div>
            <div class="col-lg col-md-3 col-6"><select name="subcategory_id" class="form-select" onchange="this.form.submit()"><option value="">All Subcategories</option>{% for s in subcategories %}<option value="{{ s.id }}" {% if selected_subcategory == s.id|string %}selected{% endif %}>{{ s.sub_category_name }}</option>{% endfor %}</select></div>
            <div class="col-lg col-md-3 col-6"><select name="color_id" class="form-select" onchange="this.form.submit()"><option value="">All Colors</option>{% for c in colors %}<option value="{{ c.id }}" {% if selected_color == c.id|string %}selected{% endif %}>{{ c.color_name }}</option>{% endfor %}</select></div>
            <div class="col-lg col-md-3 col-6"><select name="shape_id" class="form-select" onchange="this.form.submit()"><option value="">All Shapes</option>{% for s in shapes %}<option value="{{ s.id }}" {% if selected_shape == s.id|string %}selected{% endif %}>{{ s.shape_name }}</option>{% endfor %}</select></div>
        </div>
      </div>
      
      <!-- Main Content Area with Sidebar -->
      <div class="row mt-4">
        
        <!-- Sidebar Column -->
        <div class="col-lg-3 mb-5 mb-lg-0">
          <div class="filter-sidebar">
            <h4><i class="fas fa-tags"></i><span>Filter by Price</span></h4>
            <div class="mb-4">
                <label for="max_price" class="form-label">Up to: <span id="price-display">${{ selected_max_price|int|abs if selected_max_price is not none else slider_max_price|int|abs }}</span></label>
                <input type="range" class="form-range" min="10" max="{{ slider_max_price }}" step="10" id="price_slider" value="{{ selected_max_price if selected_max_price is not none else slider_max_price }}">
                <input type="hidden" name="max_price" id="max_price_input" value="{{ selected_max_price if selected_max_price is not none else slider_max_price }}">
            </div>
            
            <h4><i class="fas fa-weight-hanging"></i><span>Filter by Weight</span></h4>
            <div class="mb-4"><select name="weight_range" class="form-select" onchange="this.form.submit()"><option value="">All Weights (CT)</option>{% for wr in weight_ranges %}<option value="{{ wr.value }}" {% if selected_weight_range == wr.value %}selected{% endif %}>{{ wr.label }}</option>{% endfor %}</select></div>
            
            <div class="master-display-section">
              <h4><i class="fas fa-palette"></i><span>Available Colors</span></h4>
              {% for color in colors %}<div class="master-item"><span class="color-circle" style="background-color: {{ color.color_hex_code }};"></span><span class="item-name">{{ color.color_name }}</span></div>{% else %}<p class="text-muted small">No colors available.</p>{% endfor %}
            </div>

            <div class="master-display-section">
              <h4><i class="fas fa-shapes"></i><span>Available Shapes</span></h4>
              {% for shape in shapes %}<div class="master-item"><span class="item-name">{{ shape.shape_name }}</span></div>{% else %}<p class="text-muted small">No shapes available.</p>{% endfor %}
            </div>
          </div>
        </div>

        <!-- Products Column -->
        <div class="col-lg-9">
          <!-- Product Toolbar -->
          <div class="row product-toolbar align-items-center gy-3">
            <div class="col-lg-4 col-md-12">Showing {{ pagination.first }}-{{ pagination.last }} of {{ pagination.total_count }} results</div>
            <div class="col-lg-8 col-md-12 d-flex justify-content-lg-end justify-content-start align-items-center flex-wrap" style="gap: 1.5rem;">
                <div class="toolbar-item">
                    <strong>Show:</strong>
                    {% for option in per_page_options %}{% set params = request.args.to_dict() %}{% set _ = params.update({'per_page': option, 'page': 1}) %}<a href="{{ url_for('user.products', **params) }}" class="per-page-link {% if selected_per_page == option %}active{% endif %}">{{ option }}</a>{% if not loop.last %}<span class="text-muted">/</span>{% endif %}{% endfor %}
                </div>
                <div class="toolbar-item" id="viewModeControls">
                    <a class="view-mode-btn" data-view="list" title="List View"><i class="fas fa-bars"></i></a>
                    <a class="view-mode-btn" data-view="grid-2" title="2-column View"><i class="fas fa-th-large"></i></a>
                    <a class="view-mode-btn active" data-view="grid-3" title="3-column View"><i class="fas fa-th"></i></a>
                    <a class="view-mode-btn" data-view="grid-4" title="4-column View"><i class="fas fa-grip-horizontal"></i></a>
                </div>
            </div>
          </div>
          
          <div class="row product-grid gy-4 mt-3">
            {% if products %}{% for product in products %}<div class="product-col col-md-6 col-lg-4"><a class="product-item" href="{{ url_for('user.product_detail', id=product.id) }}"><div class="product-thumbnail-wrapper"><img src="{{ url_for('static', filename=product.images_list[0]) if product.images_list else url_for('static', filename='user/images/product-1.png') }}" class="img-fluid product-thumbnail" alt="{{ product.name }}"></div><div class="product-content"><h3 class="product-title">{{ product.name }}</h3><strong class="product-price">${{ '%.2f'|format(product.effective_price or 0) }}{% if product.offer_prize and product.offer_prize < product.prize %}<span class="old-price"><del>${{ '%.2f'|format(product.prize or 0) }}</del></span>{% endif %}</strong></div></a></div>{% endfor %}{% else %}<div class="col-12"><p class="text-center text-muted py-5">No products found matching your criteria.</p></div>{% endif %}
          </div>
          
          <nav aria-label="Page navigation" class="mt-5">
            {% if pagination and pagination.pages > 1 %}
            <ul class="pagination justify-content-center">
              <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">{% set params = request.args.to_dict() %}{% set _ = params.update({'page': pagination.prev_num}) %}<a class="page-link" href="{{ url_for('user.products', **params) if pagination.has_prev else '#' }}">«</a></li>
              {% for page_num in pagination.iter_pages() %}{% if page_num %}<li class="page-item {% if pagination.page == page_num %}active{% endif %}">{% set params = request.args.to_dict() %}{% set _ = params.update({'page': page_num}) %}<a class="page-link" href="{{ url_for('user.products', **params) }}">{{ page_num }}</a></li>{% else %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}{% endfor %}
              <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">{% set params = request.args.to_dict() %}{% set _ = params.update({'page': pagination.next_num}) %}<a class="page-link" href="{{ url_for('user.products', **params) if pagination.has_next else '#' }}">»</a></li>
            </ul>
            {% endif %}
          </nav>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.getElementById('filterForm');
    const priceSlider = document.getElementById('price_slider');
    const priceDisplay = document.getElementById('price-display');
    const maxPriceInput = document.getElementById('max_price_input');

    if (priceSlider && priceDisplay && maxPriceInput) {
      priceSlider.addEventListener('input', function() {
        priceDisplay.textContent = '$' + parseInt(this.value, 10).toLocaleString('en-US');
        maxPriceInput.value = this.value;
      });
      priceSlider.addEventListener('change', () => filterForm.submit());
    }

    const viewModeControls = document.getElementById('viewModeControls');
    const productGrid = document.querySelector('.product-grid');
    if (viewModeControls && productGrid) {
        const productCols = productGrid.querySelectorAll('.product-col');
        viewModeControls.addEventListener('click', function (event) {
            const button = event.target.closest('.view-mode-btn');
            if (!button) return;
            event.preventDefault();
            viewModeControls.querySelector('.active')?.classList.remove('active');
            button.classList.add('active');
            const view = button.dataset.view;
            productCols.forEach(col => {
                const item = col.querySelector('.product-item');
                col.className = 'product-col';
                item.classList.remove('list-view');
                switch (view) {
                    case 'list': col.classList.add('col-12', 'mb-4'); item.classList.add('list-view'); break;
                    case 'grid-2': col.classList.add('col-6', 'mb-4'); break;
                    case 'grid-3': col.classList.add('col-md-6', 'col-lg-4', 'mb-4'); break;
                    case 'grid-4': col.classList.add('col-md-4', 'col-lg-3', 'mb-4'); break;
                }
            });
        });
    }
});
</script>
{% endblock %}