{% extends "user/base.html" %}

{% block content %}
<style>
  /* --- Compact "Action Sidebar" Checkout Styling --- */
  .checkout-section {
    background-color: #f8f9fa;
    padding: 50px 0;
  }
  .checkout-container {
    max-width: 1200px;
    margin: 0 auto;
  }
  .checkout-header {
    text-align: center;
    margin-bottom: 40px;
  }
  .checkout-header h2 {
    font-weight: 600;
  }

  /* --- Main Layout: Details on Left, Actions on Right --- */
  .checkout-grid {
    display: grid;
    grid-template-columns: 1fr 440px; /* Main content and a fixed-width sidebar */
    gap: 40px;
    align-items: start;
  }

  /* --- Left Column: Shipping & Order Details --- */
  .details-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
  }
  .details-card-header {
    font-size: 1.25rem;
    font-weight: 500;
    margin-bottom: 20px;
  }
  .shipping-info p { margin: 0 0 8px 0; }
  .shipping-info strong { color: #212529; }

  .order-item {
    display: flex;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid #f1f3f5;
  }
  .order-item:first-child { padding-top: 0; }
  .order-item:last-child { border-bottom: none; padding-bottom: 0; }
  .order-item__image {
    width: 70px; height: 70px;
    object-fit: cover; border-radius: 6px; margin-right: 20px;
  }
  .order-item__details { flex-grow: 1; }
  .order-item__name { font-weight: 500; }
  .order-item__meta { font-size: 0.9rem; color: #6c757d; }
  .order-item__price { font-weight: 500; font-size: 1.1rem; margin-left: 20px; }

  /* --- Right Column: Sticky Action Sidebar --- */
  .checkout-sidebar {
    position: sticky;
    top: 20px;
  }
  .action-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 30px;
  }
  .summary-line {
    display: flex; justify-content: space-between;
    font-size: 1rem; padding: 10px 0;
  }
  .summary-line.total {
    font-size: 1.3rem; font-weight: bold; color: #3b5d50;
    border-top: 2px solid #3b5d50; margin-top: 10px; padding-top: 15px;
  }
  .payment-instructions dt { font-weight: 500; color: #6c757d; }
  .payment-instructions dd {
    font-weight: 500; color: #212529; margin-bottom: 1rem;
    display: flex; justify-content: space-between; align-items: center;
  }
  .copy-btn { font-size: 0.75rem; padding: 2px 8px; }
  #submitBtn { width: 100%; padding: 12px; font-size: 1.1rem; font-weight: 500; }

  /* --- Responsive Design --- */
  @media (max-width: 991.98px) {
    .checkout-grid {
      grid-template-columns: 1fr; /* Stack columns on tablet and mobile */
    }
    .checkout-sidebar {
      position: static; /* Remove sticky behavior */
    }
  }
</style>

<div class="checkout-section">
<div class="checkout-container">
  <div class="checkout-header">
    <h2>Complete Your Order</h2>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}{% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
    {% endfor %}{% endif %}
  {% endwith %}

  <div class="checkout-grid">
    <!-- Left Column: Order & Shipping Details -->
    <div class="checkout-main">
      <div class="details-card">
        <h3 class="details-card-header">Shipping Information</h3>
        <div class="shipping-info">
          {% if user and user.first_name and user.shipping_address %}
            <p><strong>{{ user.first_name }} {{ user.last_name or '' }}</strong></p>
            <p>{{ user.shipping_address }}</p>
            <p>{{ user.phone_number or 'N/A' }}</p>
            <a href="{{ url_for('user.user_details') }}" class="small">Change shipping address</a>
          {% else %}
            <div class="alert alert-warning">Please <a href="{{ url_for('user.user_details') }}">add your shipping details</a> to proceed.</div>
          {% endif %}
        </div>
      </div>

      <div class="details-card">
        <h3 class="details-card-header">Items in Your Order</h3>
        <div class="order-list">
          {% for item in cart_items %}
            <div class="order-item">
              {% set image_path = item.images_list[0] if item.images_list else 'user/images/default-product.png' %}
              <img src="{{ url_for('static', filename=image_path) }}" class="order-item__image" alt="{{ item.product_name }}">
              <div class="order-item__details">
                <p class="order-item__name mb-1">{{ item.product_name }}</p>
                <p class="order-item__meta">Size: {{ item.size or 'Standard' }} | Qty: {{ item.quantity }}</p>
              </div>
              <p class="order-item__price">${{ '%.2f'|format(item.size_price * item.quantity) }}</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Right Column: Actions & Totals (Sticky Sidebar) -->
    <div class="checkout-sidebar">
      <div class="action-card">
        <h3 class="details-card-header">Order Total</h3>
        <div class="summary-line">
          <span>Subtotal</span>
          <span>${{ '%.2f'|format(total_amount) }}</span>
        </div>
        <div class="summary-line">
          <span>Shipping</span>
          <span class="text-success">FREE</span>
        </div>
        <div class="summary-line total">
          <span>Total Amount</span>
          <span>${{ '%.2f'|format(total_amount) }}</span>
        </div>
        
        <hr class="my-4">

        <h3 class="details-card-header">Payment</h3>
        <p class="small text-muted mb-3">Transfer the total amount to the account below, then upload the receipt.</p>
        <dl class="payment-instructions">
          <dt>Account Number</dt>
          <dd>
            <span>{{ bank_details.account_number }}</span>
            <button class="btn btn-light btn-sm copy-btn" data-copy="{{ bank_details.account_number }}">Copy</button>
          </dd>
          <dt>Bank Name</dt>
          <dd><span>{{ bank_details.bank_name }}</span></dd>
          <dt>Account Holder</dt>
          <dd><span>{{ bank_details.account_holder }}</span></dd>
        </dl>
        
        <hr class="my-4">

        <form method="POST" action="{{ url_for('user.place_order') }}" enctype="multipart/form-data" id="orderForm">
          <input type="hidden" name="payment_method" value="bank_transfer">
          <div class="mb-3">
            <label for="payment_screenshot" class="form-label fw-bold">Upload Receipt</label>
            <input type="file" class="form-control" id="payment_screenshot" name="payment_screenshot" accept="image/png,image/jpeg,image/jpg" required>
            <div id="fileError" class="text-danger small mt-1"></div>
          </div>
          <button type="submit" class="btn btn-primary" id="submitBtn" {% if not (user and user.first_name and user.shipping_address) %}disabled{% endif %}>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Confirm & Place Order</span>
          </button>
          {% if not (user and user.first_name and user.shipping_address) %}
            <p class="small text-danger mt-2">Shipping address required to place order.</p>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Form Submission Logic ---
  const form = document.getElementById('orderForm');
  if (form) {
    const fileInput = document.getElementById('payment_screenshot');
    const submitBtn = document.getElementById('submitBtn');
    const fileError = document.getElementById('fileError');
    const spinner = submitBtn.querySelector('.spinner-border');
    const buttonText = submitBtn.querySelector('.button-text');

    form.addEventListener('submit', function(e) {
      if (submitBtn.disabled) {
        e.preventDefault(); return;
      }
      if (!fileInput.files.length) {
        e.preventDefault();
        fileError.textContent = 'Please upload a receipt to continue.';
        return;
      }
      submitBtn.disabled = true;
      spinner.classList.remove('d-none');
      buttonText.textContent = 'Processing...';
    });

    fileInput.addEventListener('change', () => { fileError.textContent = ''; });
  }

  // --- Copy to Clipboard Logic ---
  document.querySelectorAll('.copy-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      navigator.clipboard.writeText(this.dataset.copy).then(() => {
        const originalText = this.innerHTML;
        this.innerHTML = 'Copied!';
        this.classList.add('btn-success', 'text-white');
        this.classList.remove('btn-light');
        setTimeout(() => {
          this.innerHTML = originalText;
          this.classList.remove('btn-success', 'text-white');
          this.classList.add('btn-light');
        }, 2000);
      });
    });
  });
});
</script>
{% endblock %}