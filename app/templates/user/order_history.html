{% extends "user/base.html" %}

{% block content %}
<div class="untree_co-section">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="mb-5 text-center">
            <h2 class="section-title mt-3">My Order History</h2>
            <p class="text-muted">Track your treasures from our store to your home.</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if orders %}
          {% for order in orders %}
            
            {# --- Enhanced Order Card Layout --- #}
            <div class="card order-card mb-4 shadow-sm">
              
              {# --- Card Header: Order ID & Date --- #}
              <div class="card-header bg-light d-flex justify-content-between align-items-center fw-bold">
                <span>
                  Order #{{ order.purchase_id }}
                </span>
                <span class="text-muted small">
                  <i class="fas fa-calendar-alt me-1"></i>
                  Placed on {{ order.order_date.strftime('%B %d, %Y') if order.order_date else 'N/A' }}
                </span>
              </div>

              {# --- Card Body: Item Details, Status, Actions --- #}
              <div class="card-body">
                <div class="row g-0 align-items-center">
                  
                  {# --- Image --- #}
                  <div class="col-md-2 text-center p-2">
                    {% set image_path = order.images_list[0] if order.images_list else 'images/product-1.png' %}
                    <img src="{{ url_for('static', filename=image_path) }}" class="img-fluid rounded" style="max-height: 120px; max-width: 120px; object-fit: contain;" alt="{{ order.product_name }}">
                  </div>
                  
                  {# --- Product Info & Status --- #}
                  <div class="col-md-7">
                    <div class="ps-3">
                      <h5 class="card-title mb-2">{{ order.product_name or 'Order Item' }}</h5>
                      <p class="card-text mb-2">
                        <strong>Total:</strong> ${{ '%.2f'|format(order.taxed_subtotal) }}
                      </p>
                      
                      {# --- LOGIC BASED ON PAYMENT VERIFICATION STATUS --- #}

                      {# CASE 1: Payment VERIFIED ('true') #}
                      {% if order.payment_verify == 'true' %}
                        <div class="d-flex align-items-center gap-2">
                          <span class="badge bg-success-subtle text-success-emphasis p-2 fs-6">
                            <i class="fas fa-check-circle me-1"></i> Payment Verified
                          </span>
                          <span class="badge bg-info-subtle text-info-emphasis p-2 fs-6 text-capitalize">
                            <i class="fas fa-truck-fast me-1"></i> {{ order.status }}
                          </span>
                        </div>
                      
                      {# CASE 2: Payment PENDING ('open') #}
                      {% elif order.payment_verify == 'open' %}
                        <div class="alert alert-warning d-flex align-items-center p-2 mb-0">
                          <i class="fas fa-hourglass-half fa-lg me-2"></i>
                          <div>
                            <strong>Pending Verification:</strong> Your payment is being reviewed.
                          </div>
                        </div>

                      {# CASE 3: Payment REJECTED ('false') #}
                      {% else %}
                        <div class="alert alert-danger d-flex align-items-center p-2 mb-0">
                           <i class="fas fa-exclamation-triangle fa-lg me-2"></i>
                           <div>
                             <strong>Payment Rejected:</strong> There was an issue with your proof of payment.
                           </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  {# --- Action Buttons --- #}
                  <div class="col-md-3 text-center text-md-end p-2">
                    {% if order.payment_verify == 'true' %}
                      <a href="{{ url_for('user.user_order_details', id=order.purchase_id) }}" class="btn btn-primary">
                        <i class="fas fa-eye me-1"></i> View Details
                      </a>
                    {% elif order.payment_verify == 'open' %}
                      <button class="btn btn-secondary" disabled>Awaiting Approval</button>
                    {% else %}
                      <a href="#" class="btn btn-danger">
                        <i class="fas fa-headset me-1"></i> Contact Support
                      </a>
                    {% endif %}
                  </div>

                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {# --- Enhanced "No Orders" State --- #}
          <div class="card text-center shadow-sm">
            <div class="card-body p-5">
              <i class="fas fa-shopping-bag fa-4x text-muted mb-4"></i>
              <h3 class="card-title">Your Order History is Empty</h3>
              <p class="text-muted">It looks like you haven't placed any orders yet. Let's find something special!</p>
              <a href="{{ url_for('user.products') }}" class="btn btn-primary btn-lg mt-3">Start Shopping</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}